# Kubernetes logs with metadata configuration
# This example shows how to send Kubernetes logs with pod/namespace metadata

<match kubernetes.**>
  @type sumologic_radiant

  endpoint https://collectors.sumologic.com/receiver/v1/http/YOUR_UNIQUE_CODE_HERE

  # Use Kubernetes metadata in source fields
  # Modern Fluentd (1.16+) supports $.field.subfield syntax
  source_name ${$.kubernetes.container_name}
  source_category ${$.kubernetes.namespace_name}/${$.kubernetes.pod_name}
  source_host ${$.kubernetes.host}

  # Add Kubernetes labels as custom fields for better searchability
  custom_fields cluster=production,environment=prod

  # Log format
  log_format json
  add_timestamp true

  # Compression
  compress true
  compress_encoding gzip

  # Buffer configuration with Kubernetes metadata as chunk keys
  # This enables the $.kubernetes.* placeholders to work correctly
  <buffer $.kubernetes.namespace_name, $.kubernetes.pod_name, $.kubernetes.container_name>
    @type file
    path /var/log/fluentd-buffers/sumologic-k8s
    flush_mode interval
    flush_interval 10s
    flush_at_shutdown true
    retry_type exponential_backoff
    retry_wait 10s
    retry_max_interval 5m
    retry_timeout 3h
    chunk_limit_size 5M
    total_limit_size 1G
    overflow_action drop_oldest_chunk
  </buffer>
</match>
